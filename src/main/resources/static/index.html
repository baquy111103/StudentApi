<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User List</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <h1 class="text-center my-4">Welcome to our website</h1>
    <h2 class="text-center mt-4">List student information</h2>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        Add new student
    </button>
    <form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
    </form>
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addUserModalLabel">Add new student</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="addFullName" class="form-label">Name</label>
                            <input type="text" id="addFullName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="addBirthday" class="form-label">Birthday</label>
                            <input type="date" id="addBirthday" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="addClassName" class="form-label">Class Name</label>
                            <input type="text" id="addClassName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="addMajor" class="form-label">Major</label>
                            <input type="text" id="addMajor" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="addHomeTown" class="form-label">Hometown</label>
                            <input type="text" id="addHomeTown" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="addGender" class="form-label">Gender</label>
                            <select id="addGender" class="form-select" required>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="addAverageMark" class="form-label">Average Mark</label>
                            <input type="number" step="0.01" id="addAverageMark" class="form-control" min="0" max="10" required>
                        </div>
                    </form>
                    <div id="addResponseMessage" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success" onclick="addNewUser()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="editUserModalLabel">Edit student information</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm" method="post" enctype="multipart/form-data">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Name</label>
                            <input type="text" id="editFullName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBirthday" class="form-label">Birthday</label>
                            <input type="date" id="editBirthday" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editClassName" class="form-label">Class Name</label>
                            <input type="text" id="editClassName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMajor" class="form-label">Major</label>
                            <input type="text" id="editMajor" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editHomeTown" class="form-label">Hometown</label>
                            <input type="text" id="editHomeTown" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGender" class="form-label">Gender</label>
                            <select id="editGender" class="form-select" required>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAverageMark" class="form-label">Average Mark</label>
                            <input type="number" step="0.01" id="editAverageMark" class="form-control" min="0" max="10" required>
                        </div>
                    </form>
                    <div id="editResponseMessage" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success" onclick="updateUser()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Birthday</th>
            <th>Class Name</th>
            <th>Major</th>
            <th>Home town</th>
            <th>Gender</th>
            <th>Average Mark</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="userTableBody">
        <!-- User data will be populated here -->
        </tbody>
    </table>
</div>

<script>
    // Fetch and display user list
    async function fetchUserList() {
        try {
            const response = await fetch('/users');
            if (response.ok) {
                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = `<tr>
                        <td>${user.id}</td>
                        <td>${user.fullName}</td>
                        <td>${user.birthday}</td>
                        <td>${user.className}</td>
                        <td>${user.major}</td>
                        <td>${user.homeTown}</td>
                        <td>${user.gender}</td>
                        <td>${user.averageMark}</td>
                        <td style="white-space:nowrap">
                            <button type="button" class="btn btn-primary btn-sm" onclick="editUser(${user.id})" data-bs-toggle="modal" data-bs-target="#editUserModal">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                console.error('Failed to fetch users');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Add new user
    async function addNewUser() {
        const user = {
            fullName: document.getElementById('addFullName').value,
            birthday: document.getElementById('addBirthday').value,
            className: document.getElementById('addClassName').value,
            major: document.getElementById('addMajor').value,
            homeTown: document.getElementById('addHomeTown').value,
            gender: document.getElementById('addGender').value,
            averageMark: document.getElementById('addAverageMark').value
        };

        try {
            const response = await fetch('/users/addnewuser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            });

            if (response.ok) {
                document.getElementById('addResponseMessage').innerText = 'User added successfully';
                fetchUserList(); // Refresh user list
            } else {
                const error = await response.text();
                document.getElementById('addResponseMessage').innerText = `Error: ${error}`;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('addResponseMessage').innerText = 'An unexpected error occurred';
        }
    }

    // Edit user
    async function editUser(id) {
        try {
            const response = await fetch(`/users/edit/${id}`);
            if (response.ok) {
                const user = await response.json();
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFullName').value = user.fullName;
                document.getElementById('editBirthday').value = user.birthday;
                document.getElementById('editClassName').value = user.className;
                document.getElementById('editMajor').value = user.major;
                document.getElementById('editHomeTown').value = user.homeTown;
                document.getElementById('editGender').value = user.gender;
                document.getElementById('editAverageMark').value = user.averageMark;
            } else {
                console.error('Failed to fetch user');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Update user
    async function updateUser() {
        const id = document.getElementById('editUserId').value;
        const user = {
            fullName: document.getElementById('editFullName').value,
            birthday: document.getElementById('editBirthday').value,
            className: document.getElementById('editClassName').value,
            major: document.getElementById('editMajor').value,
            homeTown: document.getElementById('editHomeTown').value,
            gender: document.getElementById('editGender').value,
            averageMark: document.getElementById('editAverageMark').value
        };

        try {
            const response = await fetch(`/users/edit/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            });

            if (response.ok) {
                document.getElementById('editResponseMessage').innerText = 'User updated successfully';
                fetchUserList(); // Refresh user list
            } else {
                const error = await response.text();
                document.getElementById('editResponseMessage').innerText = `Error: ${error}`;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('editResponseMessage').innerText = 'An unexpected error occurred';
        }
    }

    // Delete user
    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            const response = await fetch(`/users/delete/${id}`, {
                method: 'GET'
            });

            if (response.ok) {
                alert('User deleted successfully');
                fetchUserList(); // Refresh user list
            } else {
                const error = await response.text();
                alert(`Error: ${error}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An unexpected error occurred');
        }
    }

    // Fetch and display search results
    async function searchUsers() {
        const form = document.querySelector('form[role="search"]');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();

        try {
            const response = await fetch(`/users/search?${params}`);
            if (response.ok) {
                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = `<tr>
                        <td>${user.id}</td>
                        <td>${user.fullName}</td>
                        <td>${user.birthday}</td>
                        <td>${user.className}</td>
                        <td>${user.major}</td>
                        <td>${user.homeTown}</td>
                        <td>${user.gender}</td>
                        <td>${user.averageMark}</td>
                        <td style="white-space:nowrap">
                            <button type="button" class="btn btn-primary btn-sm" onclick="editUser(${user.id})" data-bs-toggle="modal" data-bs-target="#editUserModal">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }  else {
                console.error('Failed to fetch search results');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

// Fetch and display birthday wishes
    async function fetchBirthdayWishes() {
        try {
            const response = await fetch('/users/happybirthday');
            if (response.ok) {
                const users = await response.json();
                const birthdayMessage = document.getElementById('birthdayMessage');
                birthdayMessage.innerHTML = '';
                users.forEach(user => {
                    const message = `<p>Happy Birthday, ${user.fullName}!</p>`;
                    birthdayMessage.insertAdjacentHTML('beforeend', message);
                });
            } else {
                console.error('Failed to fetch birthday wishes');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Initial fetch of user list
    fetchUserList();
    fetchBirthdayWishes();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
